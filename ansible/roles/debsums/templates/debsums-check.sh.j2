#!/bin/bash
# Debsums package integrity check script for {{ ansible_hostname }}
# Generated by Ansible

set -euo pipefail

# Configuration
REPORT_DIR="{{ debsums_report_dir | default('/var/lib/debsums/reports') }}"
LOG_FILE="/var/log/debsums/debsums-check.log"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
REPORT_FILE="${REPORT_DIR}/debsums-report-${TIMESTAMP}.txt"

# Email settings
{% if debsums_email_alerts | default(false) %}
SEND_EMAIL=true
EMAIL_TO="{{ debsums_email_to | default('root@localhost') }}"
EMAIL_FROM="{{ debsums_email_from | default('debsums@' + ansible_hostname) }}"
EMAIL_SUBJECT="Debsums Package Integrity Report - {{ ansible_hostname }}"
{% else %}
SEND_EMAIL=false
{% endif %}

# Logging function
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# Create directories if they don't exist
mkdir -p "$REPORT_DIR"
mkdir -p "$(dirname "$LOG_FILE")"

log_message "Starting debsums package integrity check"

# Run debsums check
log_message "Running debsums package verification..."

# Check for silent mode errors and capture detailed output
if debsums -s > "$REPORT_FILE" 2>&1; then
    DEBSUMS_EXIT_CODE=0
    log_message "Debsums check completed successfully - no integrity issues found"
else
    DEBSUMS_EXIT_CODE=$?
    log_message "Debsums detected package integrity issues - see report: $REPORT_FILE"
fi

# Add timestamp and hostname to report
{
    echo "Debsums Package Integrity Check Report"
    echo "Hostname: {{ ansible_hostname }}"
    echo "Date: $(date)"
    echo "Exit Code: $DEBSUMS_EXIT_CODE"
    echo "=========================="
    echo ""
    cat "$REPORT_FILE"
} > "${REPORT_FILE}.tmp" && mv "${REPORT_FILE}.tmp" "$REPORT_FILE"

# Generate summary statistics
TOTAL_CHANGED=$(grep -c "changed file" "$REPORT_FILE" 2>/dev/null || echo "0")
TOTAL_MISSING=$(grep -c "missing file" "$REPORT_FILE" 2>/dev/null || echo "0")

# Add summary to report
{
    echo ""
    echo "Summary:"
    echo "  Changed files: $TOTAL_CHANGED"
    echo "  Missing files: $TOTAL_MISSING"
    echo "  Total issues: $((TOTAL_CHANGED + TOTAL_MISSING))"
} >> "$REPORT_FILE"

log_message "Found $TOTAL_CHANGED changed files and $TOTAL_MISSING missing files"

# Email report if configured and issues detected
if [[ "$SEND_EMAIL" == "true" && $DEBSUMS_EXIT_CODE -ne 0 ]]; then
    if command -v mail >/dev/null 2>&1; then
        mail -s "$EMAIL_SUBJECT" -r "$EMAIL_FROM" "$EMAIL_TO" < "$REPORT_FILE"
        log_message "Email report sent to $EMAIL_TO"
    else
        log_message "WARNING: mail command not available, cannot send email"
    fi
fi

# Cleanup old reports (keep last {{ debsums_report_retention_days | default(30) }} days)
find "$REPORT_DIR" -name "debsums-report-*.txt" -type f -mtime +{{ debsums_report_retention_days | default(30) }} -delete 2>/dev/null || true

# Cleanup old logs (keep last 7 days)
find "$(dirname "$LOG_FILE")" -name "*.log" -type f -mtime +7 -delete 2>/dev/null || true

log_message "Debsums package integrity check completed"

exit $DEBSUMS_EXIT_CODE