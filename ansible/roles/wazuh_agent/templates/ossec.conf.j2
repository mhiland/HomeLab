<!--
  Wazuh Agent Configuration
  Generated by Ansible for {{ inventory_hostname }}
  Wazuh Server: {{ wazuh_server_url }}:{{ wazuh_server_port }}
  SSL Verification: {{ wazuh_ssl_verify }}
-->

<ossec_config>
  <client>
    <server>
      <address>{{ wazuh_server_url }}</address>
      <port>{{ wazuh_server_port }}</port>
      <protocol>{{ wazuh_server_protocol }}</protocol>
    </server>
    <config-profile>{{ wazuh_agent_config_profile }}</config-profile>
    <notify_time>{{ wazuh_notify_time }}</notify_time>
    <time-reconnect>{{ wazuh_time_reconnect }}</time-reconnect>
    <auto_restart>yes</auto_restart>
    <crypto_method>aes</crypto_method>
  </client>

  <client_buffer>
    <disabled>no</disabled>
    <queue_size>5000</queue_size>
    <events_per_second>500</events_per_second>
  </client_buffer>

  <!-- Logging configuration -->
  <logging>
    <log_format>{{ wazuh_log_format }}</log_format>
    <log_level>{{ wazuh_log_level }}</log_level>
  </logging>

  <!-- File integrity monitoring -->
  {% if wazuh_syscheck_enabled %}
  <syscheck>
    <disabled>no</disabled>
    <frequency>43200</frequency>
    <scan_on_start>yes</scan_on_start>
    
    <!-- Directories to monitor -->
    <directories check_all="yes">/etc,/usr/bin,/usr/sbin</directories>
    <directories check_all="yes">/bin,/sbin,/boot</directories>
    <directories check_all="yes" realtime="yes">/home</directories>
    <directories check_all="yes" realtime="yes">/root</directories>
    <directories check_all="yes">/var/log</directories>
    <directories check_all="yes">/var/www</directories>
    <directories check_all="yes">/opt</directories>
    
    <!-- Files/directories to ignore -->
    <ignore>/etc/mtab</ignore>
    <ignore>/etc/hosts.deny</ignore>
    <ignore>/etc/mail/statistics</ignore>
    <ignore>/etc/random-seed</ignore>
    <ignore>/etc/random.seed</ignore>
    <ignore>/etc/adjtime</ignore>
    <ignore>/etc/httpd/logs</ignore>
    <ignore>/etc/utmpx</ignore>
    <ignore>/etc/wtmpx</ignore>
    <ignore>/etc/cups/certs</ignore>
    <ignore>/etc/dumpdates</ignore>
    <ignore>/etc/svc/volatile</ignore>
    <ignore>/sys</ignore>
    <ignore>/proc</ignore>
    <ignore>/dev</ignore>
    <ignore>/var/log/lastlog</ignore>
    <ignore>/var/log/wtmp</ignore>
    <ignore>/var/log/btmp</ignore>
    <ignore>/var/run</ignore>
    <ignore>/var/lock</ignore>
    
    <!-- Check for changes in file attributes -->
    <check_all>yes</check_all>
    <check_sum>yes</check_sum>
    <check_sha1sum>yes</check_sha1sum>
    <check_md5sum>yes</check_md5sum>
    <check_size>yes</check_size>
    <check_owner>yes</check_owner>
    <check_group>yes</check_group>
    <check_perm>yes</check_perm>
    <check_attrs>yes</check_attrs>
    <check_mtime>yes</check_mtime>
    <check_inode>yes</check_inode>
  </syscheck>
  {% endif %}

  <!-- Rootkit detection -->
  {% if wazuh_rootcheck_enabled %}
  <rootcheck>
    <disabled>no</disabled>
    <frequency>43200</frequency>
    <rootkit_files>/var/ossec/etc/rootcheck/rootkit_files.txt</rootkit_files>
    <rootkit_trojans>/var/ossec/etc/rootcheck/rootkit_trojans.txt</rootkit_trojans>
    <system_audit>/var/ossec/etc/rootcheck/system_audit_rcl.txt</system_audit>
    <system_audit>/var/ossec/etc/rootcheck/system_audit_ssh.txt</system_audit>
    <system_audit>/var/ossec/etc/rootcheck/cis_debian_linux_rcl.txt</system_audit>
    <skip_nfs>yes</skip_nfs>
  </rootcheck>
  {% endif %}

  <!-- Log analysis -->
  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/auth.log</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/syslog</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/dpkg.log</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/kern.log</location>
  </localfile>

  <localfile>
    <log_format>apache</log_format>
    <location>/var/log/nginx/access.log</location>
  </localfile>

  <localfile>
    <log_format>apache</log_format>
    <location>/var/log/nginx/error.log</location>
  </localfile>

  <!-- Command monitoring -->
  <localfile>
    <log_format>command</log_format>
    <command>df -P</command>
    <frequency>360</frequency>
  </localfile>

  <localfile>
    <log_format>command</log_format>
    <command>netstat -tulpn | sed 's/\([[:alnum:]]\+\)\ \+[[:digit:]]\+\ \+[[:digit:]]\+\ \+\(.*\):\([[:digit:]]*\)\ \+\([0-9\.\:\*]\+\):\([[:digit:]]*\)\ \+\([[:alpha:]]\+\)\ \+\([[:digit:]]*\/[[:alnum:]\-]*\).*/\1 \2 \3 \4 \5 \6 \7/' | sort -k 6 -g</command>
    <frequency>360</frequency>
  </localfile>

  <localfile>
    <log_format>command</log_format>
    <command>last -n 20</command>
    <frequency>360</frequency>
  </localfile>

  <!-- Process monitoring -->
  <localfile>
    <log_format>command</log_format>
    <command>ps aux | sort -k 3 -rn | head -10</command>
    <frequency>300</frequency>
  </localfile>

  <!-- System inventory -->
  {% if wazuh_inventory_enabled %}
  <wodle name="syscollector">
    <disabled>no</disabled>
    <interval>1h</interval>
    <scan_on_start>yes</scan_on_start>
    <hardware>yes</hardware>
    <os>yes</os>
    <network>yes</network>
    <packages>yes</packages>
    <ports all="no">yes</ports>
    <processes>yes</processes>
    <hotfixes>yes</hotfixes>
  </wodle>
  {% endif %}

  <!-- Vulnerability detection -->
  <wodle name="vulnerability-detector">
    <disabled>no</disabled>
    <interval>5m</interval>
    <ignore_time>6h</ignore_time>
    <run_on_start>yes</run_on_start>
    <feed name="ubuntu-18">
      <disabled>no</disabled>
      <update_interval>1h</update_interval>
    </feed>
    <feed name="ubuntu-20">
      <disabled>no</disabled>
      <update_interval>1h</update_interval>
    </feed>
    <feed name="ubuntu-22">
      <disabled>no</disabled>
      <update_interval>1h</update_interval>
    </feed>
    <feed name="debian-11">
      <disabled>no</disabled>
      <update_interval>1h</update_interval>
    </feed>
    <feed name="debian-12">
      <disabled>no</disabled>
      <update_interval>1h</update_interval>
    </feed>
  </wodle>

  <!-- Security Configuration Assessment -->
  <wodle name="sca">
    <disabled>no</disabled>
    <interval>12h</interval>
    <scan_on_start>yes</scan_on_start>
    <policies>
      <policy>cis_debian_linux_rcl.yml</policy>
      <policy>system_audit_rcl.yml</policy>
      <policy>system_audit_ssh.yml</policy>
    </policies>
  </wodle>

  <!-- Active response -->
  {% if wazuh_active_response_enabled %}
  <active-response>
    <disabled>no</disabled>
    <ca_store>/var/ossec/etc/wpk_root.pem</ca_store>
    <ca_verification>yes</ca_verification>
  </active-response>
  {% else %}
  <active-response>
    <disabled>yes</disabled>
  </active-response>
  {% endif %}

  <!-- Labels for agent grouping -->
  <labels>
    <label key="environment">homelab</label>
    <label key="architecture">{{ ansible_architecture }}</label>
    <label key="os">{{ ansible_distribution }}</label>
    <label key="os_version">{{ ansible_distribution_version }}</label>
    <label key="hostname">{{ inventory_hostname }}</label>
    <label key="ip">{{ ansible_default_ipv4.address }}</label>
    <label key="groups">{{ wazuh_agent_groups }}</label>
  </labels>
</ossec_config>